name: Deploy to Google Cloud Run with Docker

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Nombre del servicio en Cloud Run'
        required: true
        type: string
      region:
        description: 'RegiÃ³n de Google Cloud'
        required: false
        type: string
        default: 'us-central1'
      timeout:
        description: 'Timeout del servicio en segundos'
        required: false
        type: string
        default: '3600'
      project_id:
        description: 'ID del proyecto de Google Cloud'
        required: true
        type: string
      environment:
        description: 'Ambiente de despliegue (test/prod)'
        required: false
        type: string
        default: 'test'
      dockerfile:
        description: 'Path al Dockerfile'
        required: false
        type: string
        default: 'dockerfile'
      artifact_registry_name:
        description: 'Nombre del Artifact Registry (se crea si no existe)'
        required: false
        type: string
        default: 'docker-images'
      working_directory:
        description: 'Directorio de trabajo (relativo al repo)'
        required: false
        type: string
        default: '.'
    secrets:
      gcloud_sa_key:
        description: 'Service Account Key de Google Cloud (JSON)'
        required: true
      github_token:
        description: 'GitHub Personal Access Token para acceder a workflow-mgmt'
        required: false
    outputs:
      service_url:
        description: 'URL del servicio desplegado'
        value: ${{ jobs.deploy.outputs.service_url }}
      image_url:
        description: 'URL de la imagen Docker desplegada'
        value: ${{ jobs.deploy.outputs.image_url }}

jobs:
  # CI: Build y Push de imagen Docker
  build:
    name: CI - Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_url: ${{ steps.build_push.outputs.image }}
      image_tag: ${{ steps.image_tag.outputs.tag }}

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Checkout workflow-mgmt
      uses: actions/checkout@v4
      with:
        repository: CPEL-SAC/workflow-mgmt
        path: .workflow-mgmt
        token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}

    - name: Generar image tag
      id: image_tag
      run: |
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        IMAGE_TAG="dev-${COMMIT_SHORT}"
        echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "commit=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
        echo "### ðŸ·ï¸ CI - Tag de Imagen" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${COMMIT_SHORT}\`" >> $GITHUB_STEP_SUMMARY

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configurar Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'

    - name: Autenticar con Google Cloud
      env:
        GCLOUD_SA_KEY: ${{ secrets.gcloud_sa_key }}
        GCLOUD_PROJECT_ID: ${{ inputs.project_id }}
      run: |
        bash .workflow-mgmt/scripts/gcloud/auth.sh

    - name: Configurar Artifact Registry
      id: setup_registry
      env:
        GCLOUD_PROJECT_ID: ${{ inputs.project_id }}
      run: |
        OUTPUT=$(bash .workflow-mgmt/scripts/gcloud/setup-artifact-registry.sh \
          "${{ inputs.artifact_registry_name }}" \
          "${{ inputs.region }}")

        REGISTRY_URL=$(echo "$OUTPUT" | grep "ARTIFACT_REGISTRY_URL=" | cut -d'=' -f2)
        echo "url=${REGISTRY_URL}" >> $GITHUB_OUTPUT

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** \`${REGISTRY_URL}\`" >> $GITHUB_STEP_SUMMARY

    - name: Build imagen Docker con docker build
      id: docker_build
      working-directory: ${{ inputs.working_directory }}
      run: |
        FULL_IMAGE="${{ steps.setup_registry.outputs.url }}/${{ inputs.service_name }}:${{ steps.image_tag.outputs.tag }}"

        echo "### ðŸ”¨ CI - Building con Docker" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Comando:** \`docker build\`" >> $GITHUB_STEP_SUMMARY
        echo "**Imagen:** \`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY

        # Build usando docker build nativo
        docker build \
          -f ${{ inputs.dockerfile }} \
          -t "${FULL_IMAGE}" \
          -t "${{ steps.setup_registry.outputs.url }}/${{ inputs.service_name }}:latest" \
          .

        echo "image=${FULL_IMAGE}" >> $GITHUB_OUTPUT

    - name: Push imagen a Artifact Registry con docker push
      id: build_push
      run: |
        FULL_IMAGE="${{ steps.docker_build.outputs.image }}"

        echo "### ðŸ“¤ CI - Pushing con Docker" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Comando:** \`docker push\`" >> $GITHUB_STEP_SUMMARY

        # Push usando docker push nativo
        docker push "${FULL_IMAGE}"
        docker push "${{ steps.setup_registry.outputs.url }}/${{ inputs.service_name }}:latest"

        echo "image=${FULL_IMAGE}" >> $GITHUB_OUTPUT

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… CI - Imagen Publicada" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Imagen:** \`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Latest:** \`${{ steps.setup_registry.outputs.url }}/${{ inputs.service_name }}:latest\`" >> $GITHUB_STEP_SUMMARY

  # CD: Deploy a Cloud Run usando gcloud
  deploy:
    name: CD - Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ inputs.environment }}
    outputs:
      service_url: ${{ steps.get_url.outputs.url }}
      image_url: ${{ needs.build.outputs.image_url }}

    steps:
    - name: Configurar Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'

    - name: Autenticar con Google Cloud
      run: |
        echo '${{ secrets.gcloud_sa_key }}' > /tmp/gcloud-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
        gcloud config set project ${{ inputs.project_id }}
        rm /tmp/gcloud-key.json

    - name: Desplegar a Cloud Run con gcloud y Secret Manager
      env:
        GCLOUD_PROJECT_ID: ${{ inputs.project_id }}
      run: |
        echo "### ðŸš€ CD - Desplegando con gcloud" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Comando:** \`gcloud run deploy\`" >> $GITHUB_STEP_SUMMARY
        echo "**Imagen:** \`${{ needs.build.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Secret Manager:** \`${{ inputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY

        # Obtener las variables del secret como JSON
        SECRET_DATA=$(gcloud secrets versions access latest \
          --secret="${{ inputs.service_name }}" \
          --project="${{ inputs.project_id }}" 2>/dev/null || echo "{}")

        # Construir argumentos de variables de entorno
        ENV_VARS=$(echo "$SECRET_DATA" | jq -r 'to_entries | map("\(.key)=\(.value)") | join(",")')

        # Deploy con variables de entorno desde Secret Manager
        if [[ -n "$ENV_VARS" ]] && [[ "$ENV_VARS" != "" ]]; then
          echo "**Variables:** Cargadas desde Secret Manager" >> $GITHUB_STEP_SUMMARY

          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ needs.build.outputs.image_url }} \
            --platform managed \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --timeout=${{ inputs.timeout }} \
            --set-env-vars="$ENV_VARS" \
            --quiet
        else
          echo "âš ï¸ **Advertencia:** No se encontrÃ³ secret, desplegando sin variables" >> $GITHUB_STEP_SUMMARY

          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ needs.build.outputs.image_url }} \
            --platform managed \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --timeout=${{ inputs.timeout }} \
            --quiet
        fi

    - name: Obtener URL del servicio
      id: get_url
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ inputs.service_name }} \
          --region ${{ inputs.region }} \
          --project ${{ inputs.project_id }} \
          --format='value(status.url)' 2>/dev/null || echo "")
        echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… CD - Despliegue Exitoso" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Servicio:** ${{ inputs.service_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**RegiÃ³n:** ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** ${SERVICE_URL}" >> $GITHUB_STEP_SUMMARY
        echo "**Ambiente:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Imagen:** \`${{ needs.build.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** \`${{ needs.build.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        gcloud auth revoke --all || true
