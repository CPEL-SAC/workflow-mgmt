name: Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      project_id:
        required: true
        type: string
      image_url:
        required: true
        type: string
      region:
        required: false
        type: string
        default: 'us-central1'
      timeout:
        required: false
        type: string
        default: '3600'
      use_secret_manager:
        required: false
        type: boolean
        default: true
    secrets:
      gcp_credentials:
        required: true

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.gcp_credentials }}

    - name: Deploy to Cloud Run
      run: |
        if [ "${{ inputs.use_secret_manager }}" = "true" ]; then
          SECRET_DATA=$(gcloud secrets versions access latest \
            --secret=${{ inputs.service_name }} \
            --project=${{ inputs.project_id }} 2>/dev/null || echo "{}")

          ENV_VARS=$(echo "$SECRET_DATA" | jq -r 'to_entries | map("\(.key)=\(.value)") | join(",")')

          if [[ -n "$ENV_VARS" ]] && [[ "$ENV_VARS" != "" ]]; then
            gcloud run deploy ${{ inputs.service_name }} \
              --image ${{ inputs.image_url }} \
              --platform managed \
              --region ${{ inputs.region }} \
              --project ${{ inputs.project_id }} \
              --timeout=${{ inputs.timeout }} \
              --set-env-vars="$ENV_VARS" \
              --quiet
          else
            gcloud run deploy ${{ inputs.service_name }} \
              --image ${{ inputs.image_url }} \
              --platform managed \
              --region ${{ inputs.region }} \
              --project ${{ inputs.project_id }} \
              --timeout=${{ inputs.timeout }} \
              --quiet
          fi
        else
          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ inputs.image_url }} \
            --platform managed \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --timeout=${{ inputs.timeout }} \
            --quiet
        fi
