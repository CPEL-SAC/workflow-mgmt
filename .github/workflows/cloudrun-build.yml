name: Build Docker Image for Cloud Run

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      project_id:
        required: true
        type: string
      environment:
        required: false
        type: string
        default: 'dev'
      region:
        required: false
        type: string
        default: 'us-central1'
      dockerfile:
        required: false
        type: string
        default: 'dockerfile'
      registry_name:
        required: false
        type: string
        default: 'docker-images'
    secrets:
      gcp_credentials:
        required: true
    outputs:
      image_tag:
        value: ${{ jobs.build.outputs.image_tag }}
      image_url:
        value: ${{ jobs.build.outputs.image_url }}

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
      image_url: ${{ steps.tag.outputs.url }}
    steps:
    - uses: actions/checkout@v4

    - name: Generate image tag
      id: tag
      run: |
        TAG="${{ inputs.environment }}-$(git rev-parse --short HEAD)"
        URL="${{ inputs.region }}-docker.pkg.dev/${{ inputs.project_id }}/${{ inputs.registry_name }}/${{ inputs.service_name }}:${TAG}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "url=${URL}" >> $GITHUB_OUTPUT

    - uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.gcp_credentials }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ inputs.region }}-docker.pkg.dev --quiet

    - name: Ensure Artifact Registry exists
      run: |
        gcloud artifacts repositories describe ${{ inputs.registry_name }} \
          --location=${{ inputs.region }} \
          --project=${{ inputs.project_id }} || \
        gcloud artifacts repositories create ${{ inputs.registry_name }} \
          --repository-format=docker \
          --location=${{ inputs.region }} \
          --project=${{ inputs.project_id }}

    - name: Build and push image
      run: |
        docker build -f ${{ inputs.dockerfile }} -t "${{ steps.tag.outputs.url }}" .
        docker push "${{ steps.tag.outputs.url }}"
