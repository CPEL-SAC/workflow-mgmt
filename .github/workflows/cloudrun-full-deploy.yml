name: Build and Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      project_id:
        required: true
        type: string
      environment:
        required: false
        type: string
        default: 'dev'
      region:
        required: false
        type: string
        default: 'us-central1'
      dockerfile:
        required: false
        type: string
        default: 'dockerfile'
      registry_name:
        required: false
        type: string
        default: 'docker-images'
      timeout:
        required: false
        type: string
        default: '3600'
      use_secret_manager:
        required: false
        type: boolean
        default: true
    secrets:
      gcp_credentials:
        required: true

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Generate image tag
      id: tag
      run: |
        TAG="${{ inputs.environment }}-$(git rev-parse --short HEAD)"
        URL="${{ inputs.region }}-docker.pkg.dev/${{ inputs.project_id }}/${{ inputs.registry_name }}/${{ inputs.service_name }}:${TAG}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "url=${URL}" >> $GITHUB_OUTPUT

    - uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.gcp_credentials }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ inputs.region }}-docker.pkg.dev --quiet

    - name: Ensure Artifact Registry exists
      run: |
        gcloud artifacts repositories describe ${{ inputs.registry_name }} \
          --location=${{ inputs.region }} \
          --project=${{ inputs.project_id }} || \
        gcloud artifacts repositories create ${{ inputs.registry_name }} \
          --repository-format=docker \
          --location=${{ inputs.region }} \
          --project=${{ inputs.project_id }}

    - name: Build and push image
      run: |
        docker build -f ${{ inputs.dockerfile }} -t "${{ steps.tag.outputs.url }}" .
        docker push "${{ steps.tag.outputs.url }}"

    - name: Deploy to Cloud Run
      run: |
        if [ "${{ inputs.use_secret_manager }}" = "true" ]; then
          SECRET_DATA=$(gcloud secrets versions access latest \
            --secret=${{ inputs.service_name }} \
            --project=${{ inputs.project_id }} 2>/dev/null || echo "{}")

          if [[ "$SECRET_DATA" != "{}" ]] && [[ -n "$SECRET_DATA" ]]; then
            echo "$SECRET_DATA" > /tmp/env-vars.json

            gcloud run deploy ${{ inputs.service_name }} \
              --image ${{ steps.tag.outputs.url }} \
              --platform managed \
              --region ${{ inputs.region }} \
              --project ${{ inputs.project_id }} \
              --timeout=${{ inputs.timeout }} \
              --update-env-vars "^:^/tmp/env-vars.json" \
              --quiet

            rm /tmp/env-vars.json
          else
            gcloud run deploy ${{ inputs.service_name }} \
              --image ${{ steps.tag.outputs.url }} \
              --platform managed \
              --region ${{ inputs.region }} \
              --project ${{ inputs.project_id }} \
              --timeout=${{ inputs.timeout }} \
              --quiet
          fi
        else
          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ steps.tag.outputs.url }} \
            --platform managed \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --timeout=${{ inputs.timeout }} \
            --quiet
        fi
