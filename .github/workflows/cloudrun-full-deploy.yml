name: Build and Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      project_id:
        required: true
        type: string
      environment:
        required: false
        type: string
        default: 'dev'
      region:
        required: false
        type: string
        default: 'us-central1'
      dockerfile:
        required: false
        type: string
        default: 'dockerfile'
      registry_name:
        required: false
        type: string
        default: 'cloudrun-images'
      timeout:
        required: false
        type: string
        default: '3600'
      use_secret_manager:
        required: false
        type: boolean
        default: true
    secrets:
      gcp_credentials:
        required: true

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Generate image tag
      id: tag
      run: |
        TAG="${{ inputs.environment }}-$(git rev-parse --short HEAD)"
        URL="${{ inputs.region }}-docker.pkg.dev/${{ inputs.project_id }}/${{ inputs.registry_name }}/${{ inputs.service_name }}:${TAG}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "url=${URL}" >> $GITHUB_OUTPUT

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.gcp_credentials }}

    - name: Ensure Artifact Registry exists
      run: |
        gcloud artifacts repositories describe ${{ inputs.registry_name }} \
          --location=${{ inputs.region }} \
          --project=${{ inputs.project_id }} || \
        gcloud artifacts repositories create ${{ inputs.registry_name }} \
          --repository-format=docker \
          --location=${{ inputs.region }} \
          --project=${{ inputs.project_id }}

    - name: Build and push image with Cloud Build
      id: build
      run: |
        echo "Building with Cloud Build to enable source tracking..."

        # Create inline cloudbuild.yaml to specify dockerfile name
        cat > /tmp/cloudbuild.yaml <<EOF
        steps:
        - name: 'gcr.io/cloud-builders/docker'
          args: ['build', '-f', '${{ inputs.dockerfile }}', '-t', '${{ steps.tag.outputs.url }}', '.']
        images:
        - '${{ steps.tag.outputs.url }}'
        EOF

        BUILD_ID=$(gcloud builds submit \
          --config=/tmp/cloudbuild.yaml \
          --project ${{ inputs.project_id }} \
          --timeout=600 \
          --format="value(id)")

        rm /tmp/cloudbuild.yaml

        echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
        echo "✅ Build completed with ID: ${BUILD_ID}"

    - name: Deploy to Cloud Run
      run: |
        if [ "${{ inputs.use_secret_manager }}" = "true" ]; then
          SECRET_NAME="${{ inputs.service_name }}-${{ inputs.environment }}"

          SECRET_DATA=$(gcloud secrets versions access latest \
            --secret="${SECRET_NAME}" \
            --project=central-secrets 2>/dev/null || echo "{}")

          if [[ "$SECRET_DATA" != "{}" ]] && [[ -n "$SECRET_DATA" ]]; then
            echo "$SECRET_DATA" > /tmp/env-vars.json

            gcloud run deploy ${{ inputs.service_name }} \
              --image ${{ steps.tag.outputs.url }} \
              --platform managed \
              --region ${{ inputs.region }} \
              --project ${{ inputs.project_id }} \
              --timeout=${{ inputs.timeout }} \
              --env-vars-file /tmp/env-vars.json \
              --quiet

            rm /tmp/env-vars.json
          else
            gcloud run deploy ${{ inputs.service_name }} \
              --image ${{ steps.tag.outputs.url }} \
              --platform managed \
              --region ${{ inputs.region }} \
              --project ${{ inputs.project_id }} \
              --timeout=${{ inputs.timeout }} \
              --quiet
          fi
        else
          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ steps.tag.outputs.url }} \
            --platform managed \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --timeout=${{ inputs.timeout }} \
            --quiet
        fi

    - name: Update service with build source annotations
      if: steps.build.outputs.build_id != ''
      run: |
        echo "Updating Cloud Run service with build source annotations..."

        # Get build information
        BUILD_ID="${{ steps.build.outputs.build_id }}"

        # Get source location from the build
        SOURCE_LOCATION=$(gcloud builds describe ${BUILD_ID} \
          --project ${{ inputs.project_id }} \
          --format="value(source.storageSource.bucket,source.storageSource.object,source.storageSource.generation)" \
          | tr '\t' '/')

        if [[ -n "$SOURCE_LOCATION" ]]; then
          # Export current service config
          gcloud run services describe ${{ inputs.service_name }} \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --format export > /tmp/service-config.yaml

          # Add build annotations using sed
          sed -i "/^  annotations:/a\    run.googleapis.com/build-id: ${BUILD_ID}" /tmp/service-config.yaml
          sed -i "/^  annotations:/a\    run.googleapis.com/build-source-location: gs://${SOURCE_LOCATION}" /tmp/service-config.yaml

          # Apply updated config
          gcloud run services replace /tmp/service-config.yaml \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }} \
            --quiet

          rm /tmp/service-config.yaml

          echo "✅ Build source annotations added to service"
          echo "   Build ID: ${BUILD_ID}"
          echo "   Source: gs://${SOURCE_LOCATION}"
        else
          echo "⚠️  Could not retrieve source location from build"
        fi
