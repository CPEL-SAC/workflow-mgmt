name: Hotfix Auto-Backport

# Workflow reutilizable para backport automÃ¡tico de hotfixes a develop
# Garantiza que las correcciones de producciÃ³n se repliquen automÃ¡ticamente

on:
  workflow_call:
    inputs:
      hotfix_branch:
        description: 'Nombre del branch hotfix (ej: hotfix/fix-critical-bug)'
        required: true
        type: string
      target_branch:
        description: 'Branch destino para el backport (normalmente develop)'
        required: false
        type: string
        default: 'develop'
    secrets:
      github_token:
        description: 'GitHub token con permisos de write'
        required: false

jobs:
  auto-backport:
    name: Backport ${{ inputs.hotfix_branch }} â†’ ${{ inputs.target_branch }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate branches
        run: |
          echo "ğŸ” Validando branches..."
          git fetch origin ${{ inputs.target_branch }}
          git fetch origin ${{ inputs.hotfix_branch }}

          if ! git show-ref --verify --quiet refs/remotes/origin/${{ inputs.hotfix_branch }}; then
            echo "âŒ Error: El branch ${{ inputs.hotfix_branch }} no existe"
            exit 1
          fi

          if ! git show-ref --verify --quiet refs/remotes/origin/${{ inputs.target_branch }}; then
            echo "âŒ Error: El branch ${{ inputs.target_branch }} no existe"
            exit 1
          fi

          echo "âœ… Branches validados correctamente"

      - name: Create backport branch
        id: create-backport
        run: |
          HOTFIX_BRANCH="${{ inputs.hotfix_branch }}"
          TARGET_BRANCH="${{ inputs.target_branch }}"
          BACKPORT_BRANCH="backport/${HOTFIX_BRANCH}-to-${TARGET_BRANCH}"

          # Limpiar nombre del branch (remover hotfix/ si existe)
          CLEAN_HOTFIX=$(echo ${HOTFIX_BRANCH} | sed 's|hotfix/||g')
          BACKPORT_BRANCH="backport/${CLEAN_HOTFIX}-to-${TARGET_BRANCH}"

          echo "hotfix_branch=${HOTFIX_BRANCH}" >> $GITHUB_OUTPUT
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          echo "backport_branch=${BACKPORT_BRANCH}" >> $GITHUB_OUTPUT

          echo "ğŸ“ Hotfix: ${HOTFIX_BRANCH}"
          echo "ğŸ“ Target: ${TARGET_BRANCH}"
          echo "ğŸ“ Backport branch: ${BACKPORT_BRANCH}"

          # Verificar si el branch de backport ya existe
          if git show-ref --verify --quiet refs/remotes/origin/${BACKPORT_BRANCH}; then
            echo "âš ï¸ El branch de backport ya existe, eliminando..."
            git push origin --delete ${BACKPORT_BRANCH} || true
          fi

          # Crear branch de backport desde target
          git checkout -b ${BACKPORT_BRANCH} origin/${TARGET_BRANCH}

      - name: Perform backport (cherry-pick)
        id: backport
        continue-on-error: true
        run: |
          HOTFIX_BRANCH="${{ steps.create-backport.outputs.hotfix_branch }}"

          echo "ğŸ”„ Intentando cherry-pick desde ${HOTFIX_BRANCH}..."

          # Obtener todos los commits del hotfix
          COMMITS=$(git log origin/${HOTFIX_BRANCH} --not origin/${{ inputs.target_branch }} --format="%H" --reverse)

          if [ -z "$COMMITS" ]; then
            echo "âš ï¸ No hay commits nuevos para hacer backport"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“‹ Commits a aplicar:"
          echo "$COMMITS"

          # Intentar cherry-pick
          if git cherry-pick $COMMITS; then
            echo "âœ… Cherry-pick exitoso"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Conflictos detectados durante cherry-pick"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Abortar cherry-pick y hacer merge
            git cherry-pick --abort

            # Intentar merge automÃ¡tico
            if git merge --no-commit --no-ff origin/${HOTFIX_BRANCH}; then
              git commit -m "Backport ${HOTFIX_BRANCH} to ${{ inputs.target_branch }} via merge" || true
            else
              # Conflictos en merge, crear commit con marcadores de conflicto
              git add -A
              git commit -m "Backport ${HOTFIX_BRANCH} to ${{ inputs.target_branch }} (REQUIRES MANUAL CONFLICT RESOLUTION)" || true
            fi
          fi

      - name: Push backport branch
        if: steps.backport.outputs.has_changes == 'true'
        run: |
          BACKPORT_BRANCH="${{ steps.create-backport.outputs.backport_branch }}"
          echo "â¬†ï¸ Pushing ${BACKPORT_BRANCH}..."
          git push origin ${BACKPORT_BRANCH}

      - name: Create Pull Request
        if: steps.backport.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
        run: |
          HOTFIX_BRANCH="${{ steps.create-backport.outputs.hotfix_branch }}"
          TARGET_BRANCH="${{ steps.create-backport.outputs.target_branch }}"
          BACKPORT_BRANCH="${{ steps.create-backport.outputs.backport_branch }}"
          HAS_CONFLICTS="${{ steps.backport.outputs.has_conflicts }}"

          CONFLICT_WARNING=""
          if [ "$HAS_CONFLICTS" = "true" ]; then
            CONFLICT_WARNING="âš ï¸ **ATENCIÃ“N: Este PR tiene conflictos que requieren resoluciÃ³n manual**"
          fi

          PR_BODY="## ğŸš¨ Backport AutomÃ¡tico de Hotfix

          Este PR fue **generado automÃ¡ticamente** para replicar el hotfix a ${TARGET_BRANCH}.

          ${CONFLICT_WARNING}

          ### ğŸ“‹ Detalles
          - **Hotfix original:** \`${HOTFIX_BRANCH}\`
          - **Branch destino:** \`${TARGET_BRANCH}\`
          - **Backport branch:** \`${BACKPORT_BRANCH}\`
          - **Conflictos detectados:** ${HAS_CONFLICTS}

          ### âœ… AcciÃ³n Requerida
          1. âœ”ï¸ Revisar los cambios aplicados
          2. âœ”ï¸ Resolver conflictos si los hay
          3. âœ”ï¸ Validar que el cambio es compatible con ${TARGET_BRANCH}
          4. âœ”ï¸ Aprobar y mergear este PR

          ### âš ï¸ Importante
          - âŒ **NO eliminar este PR** sin mergear
          - âœ… Este backport es **OBLIGATORIO** segÃºn la estrategia Git Flow
          - ğŸ”’ Si hay conflictos, deben resolverse antes de mergear
          - ğŸ“Œ Esto garantiza que las correcciones de producciÃ³n no se pierdan

          ### ğŸ¯ Estrategia Git Flow
          SegÃºn la estrategia establecida:
          > *\"Backport obligatorio hotfix/* â†’ develop\"*
          >
          > Esto evita que el fix se pierda en futuros despliegues.

          ---
          ğŸ¤– Generado automÃ¡ticamente por GitHub Actions
          ğŸ“… $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          gh pr create \
            --base ${TARGET_BRANCH} \
            --head ${BACKPORT_BRANCH} \
            --title "ğŸ”„ [AUTO-BACKPORT] ${HOTFIX_BRANCH} â†’ ${TARGET_BRANCH}" \
            --body "${PR_BODY}" \
            --label "hotfix-backport,automated,priority-high" || {
              echo "âš ï¸ No se pudo crear el PR. Puede que ya exista."
              echo "ğŸ“‹ Verificando PRs existentes..."
              gh pr list --head ${BACKPORT_BRANCH} || true
              exit 0
            }

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… BACKPORT AUTOMÃTICO COMPLETADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Detalles:"
          echo "   Hotfix: ${{ steps.create-backport.outputs.hotfix_branch }}"
          echo "   Destino: ${{ steps.create-backport.outputs.target_branch }}"
          echo "   Branch creado: ${{ steps.create-backport.outputs.backport_branch }}"
          echo ""
          if [ "${{ steps.backport.outputs.has_changes }}" = "true" ]; then
            echo "âœ… Se creÃ³ un Pull Request automÃ¡ticamente"
            echo "ğŸ”” El equipo debe revisar y aprobar el PR"
            if [ "${{ steps.backport.outputs.has_conflicts }}" = "true" ]; then
              echo "âš ï¸ ATENCIÃ“N: Hay conflictos que requieren resoluciÃ³n manual"
            fi
          else
            echo "â„¹ï¸ No hay cambios nuevos para hacer backport"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
